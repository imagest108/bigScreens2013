<html>
  <head>

    <meta name="viewport" content="width=device-width, user-scalable=no">

    <link rel="stylesheet" type="text/css" href="/css/main.css">
    
    <script src="/js/toxiclibs.js"></script>
    <script src="/js/processing-1.4.1.js"></script>
    <script src="/socket.io/socket.io.js"></script>  
    <script>

      //var socket = io.connect('http://bigscreensprototype.herokuapp.com/');
      //var socket = io.connect('http://localhost:5000/');
      var socket = io.connect('http://ec2-54-200-79-16.us-west-2.compute.amazonaws.com:8080/');

      var id; 
      var userObjs = [];

      var objectX;
      var objectY;
      var objectID; 

      socket.on('connect', function(){

        console.log("Connected : "+socket.socket.sessionid+","+userObjs.length);
        id = socket.socket.sessionid;
      });

      socket.on('news', function (data) {
           //console.log(data);
           
           if(data.index > 0) {
            createUser(data);
           }else {
            displayCanvas();
           }

      });

      socket.on('button', function (data) {

       for(var i = 0 ; i < userObjs.length; i++){


          if(userObjs[i].objectID == data.id){
            console.log("find the moving user!");
            chooseOne(data);
          }
        } 
      });

      var sendbtn = function(button) {
        socket.emit('button', { id: id, button: button });
      };

      socket.on('message', function (data){

        console.log("Recieved : "+ data);

      });

      socket.on('disconnect', function (data){

        //console.log("Disconnected User : "+ data);
        removeUser(data);

      });

      var canvas;
      var context;
      var processingInstance;


      var initcanvas = function(){

        canvas = document.getElementById("thecanvas");  
        context = canvas.getContext('2d');
        
      };

      var chooseOne = function (data){
        var choice = {
             objectID : data.id,
             sectionID : data.button,
        };

        var pjs = Processing.getInstanceById("thecanvas");          
        //pjs.addUser(userObj.objectID);
        pjs.setSection(choice.objectID, choice.sectionID);

      };

      var createUser = function (data){

        var userObj = {

          objectID : data.uid,
          objectIndex : "user"+ data.index,

        };

        userObjs.push(userObj);
        //console.log(userObjs);

        var pjs = Processing.getInstanceById("thecanvas");          
        //pjs.addUser(userObj.objectID);
        pjs.addParticle(userObj.objectID);
        
      };

      var removeUser = function(data){

        for(var i = 0 ; i < userObjs.length ; i++){

          if(userObjs[i].objectID == data){

              userObjs.splice(i,1);
              //console.log(userObjs);

              var pjs = Processing.getInstanceById("thecanvas");          
              pjs.removeUsers(data);

          }
        }
      };

      var displayCanvas = function(){
        canvas.style.display="inline";
        
        var Display_socket_buttons = document.getElementById("gui"); 
        Display_socket_buttons.style.display = "none";        
      };      


    </script>
    
  </head>
  <body onload = "initcanvas();">
    
    <div class="container" id = "gui" style = "display:inline">
      <div id="debug"><h3>Choose a land of survival!</h3></div>
       <button id="red" onclick= "sendbtn(1);"></button>
       <br/>
       <button id="yellow" onclick= "sendbtn(2);"></button>
       <br/>
       <button id="purple" onclick= "sendbtn(3);"></button>
    </div>
    <canvas width = "1212" height = "558" id = "thecanvas" style = "display:none" data-processing-sources="/pjs/example.pde"></canvas>

  </body>
</html>