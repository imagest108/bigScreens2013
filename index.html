<html>
  <head>

    <meta name="viewport" content="width=device-width, user-scalable=no">

    <link rel="stylesheet" type="text/css" href="/css/main.css">
    <script type="text/javascript" charset="utf-8" src="http://o.aolcdn.com/dojo/1.1.1/dojo/dojo.xd.js"></script>
  
    <script src="/js/processing-1.4.1.js"></script>
    <script src="/socket.io/socket.io.js"></script>  
    <script>

      var socket = io.connect('http://bigscreensprototype2.herokuapp.com/');

      var id; 
      var userObjs = [];

      var objectX;
      var objectY;
      var objectID; 

      socket.on('connect', function(){

        console.log("Connected : "+socket.socket.sessionid+","+userObjs.length);
        id = socket.socket.sessionid;
      });

      socket.on('news', function (data) {
           console.log(data);
           
           if(data.index > 0) {
            createUser(data);
           }else {
            displayCanvas();
           }

      });


      socket.on('button', function (data) {

        for(var i = 0 ; i < userObjs.length; i++){

          if(userObjs[i].objectID == data.id){
            console.log("find the moving user!");
            updateUser(userObjs[i], data.button);

          }
        } 
      });

      var sendbtn = function(button) {
        socket.emit('button', { id: id, button: button });
      };

      dojo.addOnLoad(function(){

        var redBtn = dojo.byId("red"); 
        var greenBtn = dojo.byId("green"); 

        var dragging = false;
        var sizing = false;
        var rotating = 0;


        function touch(evt){
          
          dojo.forEach(evt.changedTouches, function(e){

            e.preventDefault(); 

            var target = e.target;

            if(target == greenBtn || target == redBtn){
              if(!dragging) {
                // Save the offset of the touch within the current note 
                          dragging = [e.pageX - dojo.style(node, "left"), e.pageY - dojo.style(node, "top")]; 
              }
            }
          }); 
        }


        function touchend(evt){

          dojo.forEach(evt.changedTouches, function(e){
            
            var target = e.target;

            if(target == greenBtn){
              sendbtn('green');
              document.getElementById('debug').innerHTML = 'green pressed';   

            } else if(target == redBtn) {
              sendbtn('red');
              document.getElementById('debug').innerHTML = 'red pressed';   
            }

            // Check to see if we've gone from a gesture back down to a touch
            if(e.target == redBtn || e.target == greenBtn){
              if (evt.targetTouches.length == 1) { 
                          // If there was rotation, this number needs to be reset 
                        dragging = [evt.targetTouches[0].pageX - dojo.style(node, "left"), evt.targetTouches[0].pageY - dojo.style(node, "top")]; 
                    } else if (!evt.targetTouches.length) { 
                        dragging = false; 
                    }
            }
          });
        }


        function touchmove(evt){

          evt.preventDefault();
          dojo.forEach(evt.changedTouches, function(e){
            if(e.target == redBtn || e.target == greenBtn){
              // Move the node if we're in a state of dragging, but not resizing  
              
              document.getElementById('debug').innerHTML = e.pageX + " , " + e.pageY;

              dojo.style(e.target, {
                left: e.pageX - dragging[0] + "px",
                top: e.pageY - dragging[1] + "px"
              });
            }
          });

        }

        dojo.connect(dojo.doc, "ontouchstart", touch);
        dojo.query("div").connect("ontouchmove", touchmove);
        dojo.connect(dojo.doc, "ontouchend", touchend);
      });

      socket.on('message', function (data){

        console.log("Recieved : "+ data);

      });

      socket.on('disconnect', function (data){

        console.log("Disconnected User : "+ data);
        removeUser(data);

      });

      var canvas;
      var context;
      var processingInstance;


      var initcanvas = function(){

        canvas = document.getElementById("thecanvas");  
        context = canvas.getContext('2d');
        
      };

      var updateUser = function (object, button){

            console.log("object : "+ object);
            console.log("button : "+ button);

            if(button == 'red'){

               var pjs = Processing.getInstanceById("thecanvas");   
               pjs.makeJump(object.objectID);

               }
      };

      var createUser = function (data){

            var userObj = {

          objectID : data.uid,
          objectIndex : "user"+ data.index,
          objectX : data.index*100,
          objectY : 500,

        };

        userObjs.push(userObj);
        console.log(userObjs);

        var pjs = Processing.getInstanceById("thecanvas");          
        pjs.addBall(userObj.objectX, userObj.objectY, userObj.objectID);
        
      };

      var removeUser = function(data){

        for(var i = 0 ; i < userObjs.length ; i++){

          if(userObjs[i].objectID == data){

              userObjs.splice(i,1);
              console.log(userObjs);

              var pjs = Processing.getInstanceById("thecanvas");          
              pjs.removeBall(data);

          }
        }
      };

      var displayCanvas = function(){
        canvas.style.display="inline";
        
        var Display_socket_green = document.getElementById("green");
        var Display_socket_red = document.getElementById("red");

        Display_socket_red.style.display = "none";
        Display_socket_green.style.display = "none";
        
      };      


    </script>
    
  </head>
  <body onload = "initcanvas();">
    <span id="debug"></span>
    <div id="red"><a id="red"></a></div>
    <div id="green"><a id="green"></a></div>
    <canvas width = "1212" height = "558" id = "thecanvas" style = "display:none" data-processing-sources="/pjs/ball.pde"></canvas>

  </body>
</html>